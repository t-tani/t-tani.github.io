<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReverseEngineering Basic1 | t-tani.github.io</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="description" content="アセンブリを読むために必要な基礎知識まとめ Part1">
    
    <link rel="preload" href="/assets/css/0.styles.c35f491d.css" as="style"><link rel="preload" href="/assets/js/app.e11e3c81.js" as="script"><link rel="preload" href="/assets/js/2.576ddc93.js" as="script"><link rel="preload" href="/assets/js/12.e3466742.js" as="script"><link rel="prefetch" href="/assets/js/10.0c722199.js"><link rel="prefetch" href="/assets/js/11.79641ae7.js"><link rel="prefetch" href="/assets/js/13.d8aeaef7.js"><link rel="prefetch" href="/assets/js/14.19cddd26.js"><link rel="prefetch" href="/assets/js/15.253aed9d.js"><link rel="prefetch" href="/assets/js/16.791b08fe.js"><link rel="prefetch" href="/assets/js/3.4857e633.js"><link rel="prefetch" href="/assets/js/4.3f155142.js"><link rel="prefetch" href="/assets/js/5.9e5a1c18.js"><link rel="prefetch" href="/assets/js/6.ad4d1b2a.js"><link rel="prefetch" href="/assets/js/7.c69d6380.js"><link rel="prefetch" href="/assets/js/8.125e51c6.js"><link rel="prefetch" href="/assets/js/9.b04c7655.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c35f491d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">t-tani.github.io</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/publications/" class="nav-link">
  Publications
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/publications/" class="nav-link">
  Publications
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ReverseEngineering Basic1</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/_posts/ReverseEngineeringBasic1.html#x86の主要レジスタ" class="sidebar-link">x86の主要レジスタ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#汎用レジスタ" class="sidebar-link">汎用レジスタ</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#インデックスレジスタ" class="sidebar-link">インデックスレジスタ</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#セグメントレジスタ" class="sidebar-link">セグメントレジスタ</a></li></ul></li><li><a href="/_posts/ReverseEngineeringBasic1.html#主要なオペコード" class="sidebar-link">主要なオペコード</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#データ移送" class="sidebar-link">データ移送</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#算術論理演算" class="sidebar-link">算術論理演算</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#制御" class="sidebar-link">制御</a></li></ul></li><li><a href="/_posts/ReverseEngineeringBasic1.html#c言語の逆アセンブル" class="sidebar-link">C言語の逆アセンブル</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#関数の基本的な構造" class="sidebar-link">関数の基本的な構造</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#代表的な関数の呼び出し規約" class="sidebar-link">代表的な関数の呼び出し規約</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#基本的なif文" class="sidebar-link">基本的なif文</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#基本的なループ" class="sidebar-link">基本的なループ</a></li><li class="sidebar-sub-header"><a href="/_posts/ReverseEngineeringBasic1.html#構造体とapiコール" class="sidebar-link">構造体とAPIコール</a></li></ul></li><li><a href="/_posts/ReverseEngineeringBasic1.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reverseengineering-basic1"><a href="#reverseengineering-basic1" class="header-anchor">#</a> ReverseEngineering Basic1</h1> <div data-v-bcf650bc>
  Tags:
  <a href="/tags.html#ReverseEngineering" class="tag" data-v-bcf650bc>
    ReverseEngineering
  </a><a href="/tags.html#C" class="tag" data-v-bcf650bc>
    C
  </a><a href="/tags.html#Assembly" class="tag" data-v-bcf650bc>
    Assembly
  </a></div> <p>備忘のためリバースエンジニアリングでアセンブリを読む基礎知識をまとめる。</p> <h2 id="x86の主要レジスタ"><a href="#x86の主要レジスタ" class="header-anchor">#</a> x86の主要レジスタ</h2> <h3 id="汎用レジスタ"><a href="#汎用レジスタ" class="header-anchor">#</a> 汎用レジスタ</h3> <h4 id="eax-accumulator-register"><a href="#eax-accumulator-register" class="header-anchor">#</a> EAX (Accumulator register)</h4> <p>算術演算、戻り値で利用される。</p> <h4 id="edx-data-register"><a href="#edx-data-register" class="header-anchor">#</a> EDX (Data register)</h4> <p>基本的な役割はEAXと同じだが、戻り値に利用できない。</p> <h4 id="ecx-count-register"><a href="#ecx-count-register" class="header-anchor">#</a> ECX (Count register)</h4> <p>ループを実行するときのカウントに利用する。
ただし、加算処理（<code>i++</code>）ではなく、事前にループ回数をECXに格納し減算処理 (<code>i--</code>)を行いECXが0になるまでカウントする。汎用レジスタと使用しても使用される。</p> <h4 id="ebx-base-register"><a href="#ebx-base-register" class="header-anchor">#</a> EBX (Base register)</h4> <p>特定の目的を持って作られたレジスタではない。ECX,EDX,ECXが足りない場合に利用される。データのポインターとして使われることが多い。</p> <h3 id="インデックスレジスタ"><a href="#インデックスレジスタ" class="header-anchor">#</a> インデックスレジスタ</h3> <h4 id="esi-source-index-register-edi-destination-index-register"><a href="#esi-source-index-register-edi-destination-index-register" class="header-anchor">#</a> ESI(Source Index register),EDI(Destination Index register)</h4> <p>主に文字列やデータ処理、繰り返しの処理、メモリの内容の移動に使われる。
ソースアドレス、ディスティネーションアドレスを入ることが多い。</p> <h3 id="セグメントレジスタ"><a href="#セグメントレジスタ" class="header-anchor">#</a> セグメントレジスタ</h3> <p>メモリアクセスの種類に応じて暗黙のうちにセグメントレジスタが選択される。</p> <h4 id="cs-ds-ss-es"><a href="#cs-ds-ss-es" class="header-anchor">#</a> CS/DS/SS/ES</h4> <ul><li>CS (code segment):命令フェッチ</li> <li>DS (data segment): データの読み書き</li> <li>SS (stack segment): スタックへのアクセス</li> <li>ES (extra segment): データの読み書き</li></ul> <h2 id="主要なオペコード"><a href="#主要なオペコード" class="header-anchor">#</a> 主要なオペコード</h2> <h3 id="データ移送"><a href="#データ移送" class="header-anchor">#</a> データ移送</h3> <ul><li>PUSH: スタックに値を入れる命令</li> <li>POP: スタックの値を取得する命令</li> <li>MOV: 値を入れる命令</li> <li>LEA: アドレスを入れる命令</li></ul> <h3 id="算術論理演算"><a href="#算術論理演算" class="header-anchor">#</a> 算術論理演算</h3> <ul><li>ADD: ソースからディスティネーションに値を加算する命令</li> <li>SUB: ソースからディスティネーションに値を減算する命令</li> <li>INC: <code>i++</code>と同じ</li> <li>DEC: <code>i--</code>と同じ</li> <li>AND,OR,XOR: そのまま</li></ul> <h3 id="制御"><a href="#制御" class="header-anchor">#</a> 制御</h3> <ul><li>CALL: 関数を呼び出し、戻りアドレスをスタック上にプッシュする命令</li> <li>NOP: 何もしない命令</li> <li>INT: 割り込みを発生させる命令、後ろに付くオペランドの数字によって異なる処理を行う
<ul><li>例 <code>0xCC INT 3</code> -&gt; DebugBreak()</li></ul></li> <li>CMP,JMP: 比較してジャンプする命令</li></ul> <h2 id="c言語の逆アセンブル"><a href="#c言語の逆アセンブル" class="header-anchor">#</a> C言語の逆アセンブル</h2> <p>リバースエンジニアリングにおいて、各関数がどのような役割を持っているか把握することが重要である。最終的には <code>CALL</code> される関数がどのような引数を取り、どのような処理をするかを解明して行けるようにする。</p> <h3 id="関数の基本的な構造"><a href="#関数の基本的な構造" class="header-anchor">#</a> 関数の基本的な構造</h3> <h4 id="関数の始まり方"><a href="#関数の始まり方" class="header-anchor">#</a> 関数の始まり方</h4> <p>x86では呼び出し元関数のスタック領域を保持するため、呼び出し元のスタックのベースアドレスを保存する。</p> <div class="language-nasm extra-class"><pre class="language-nasm"><code><span class="token number">55</span>            push      <span class="token register variable">ebp</span>        <span class="token comment">; スタックのベースアドレスを保存</span>
8B EC         mov       <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>   <span class="token comment">; 現在のスタックポインタアドレスをベースアドレスにする</span>
</code></pre></div><h4 id="スタックを使う関数の始まり"><a href="#スタックを使う関数の始まり" class="header-anchor">#</a> スタックを使う関数の始まり</h4> <p>関数内で使用するローカル変数などを確保するために、ESPを使用するデータサイズの大きさ確保する。</p> <div class="language-nasm extra-class"><pre class="language-nasm"><code><span class="token number">55</span>            push      <span class="token register variable">ebp</span>
8B EC         mov       <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
<span class="token number">83</span> EC <span class="token number">50</span>      sub       <span class="token register variable">esp</span>, <span class="token number">50h</span>  <span class="token comment">; 50hのサイズをローカル変数のスタックとして利用する</span>
</code></pre></div><h4 id="終わり方"><a href="#終わり方" class="header-anchor">#</a> 終わり方</h4> <p>呼び出し元のスタックのベースアドレスを ESB に戻し、関数を終了する。なお、関数の終了時にはEAXに返り値が格納される。</p> <div class="language-nasm extra-class"><pre class="language-nasm"><code><span class="token number">89</span> EC         mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
<span class="token number">5D</span>            pop    <span class="token register variable">ebp</span>        <span class="token comment">; 呼び出し元のスタックのベースアドレスを戻す</span>
</code></pre></div><h3 id="代表的な関数の呼び出し規約"><a href="#代表的な関数の呼び出し規約" class="header-anchor">#</a> 代表的な関数の呼び出し規約</h3> <h4 id="cdecl"><a href="#cdecl" class="header-anchor">#</a> __cdecl</h4> <ul><li>インテルx86ベースのシステム上のC/C++で使われることが多い</li> <li>関数への引数は右から左の順でスタックに積まれる</li> <li>関数の戻り値は EAXに格納される</li> <li>呼び出された側の関数ではEAX, ECX, EDXのレジスタの元の値を保存することなく使用してよい</li> <li>呼び出し側の関数では必要ならば呼び出す前にそれらのレジスタをスタック上などに保存する</li> <li><strong>スタックポインターの処理は呼び出し側で行う</strong> <ul><li>スタックポインターの値を引数を積む前の値に戻す処理</li></ul></li></ul> <h4 id="stdcall"><a href="#stdcall" class="header-anchor">#</a> __stdcall</h4> <ul><li>主にWin32 APIにおけるデファクトスタンダード</li> <li>関数への引数は右から左の順でスタックに積まれる</li> <li>関数の戻り値は EAXに格納される</li> <li><strong>関数内でスタックポインターの処理を行う</strong> <ul><li>スタックポインターの値を引数を積む前の値に戻す処理</li> <li><code>retn 8</code> のような形で関数が終わる</li> <li>ただし、引数が可変長のときは、<strong>スタックポインターの処理は呼び出し側で行う</strong></li></ul></li></ul> <h4 id="fastcall"><a href="#fastcall" class="header-anchor">#</a> __fastcall</h4> <ul><li>高速処理ををしたいときに利用</li> <li>関数の引数が2つ以下の場合、<code>push</code>を使用せず、ECX,EDXを経由して渡す</li></ul> <h4 id="thiscall"><a href="#thiscall" class="header-anchor">#</a> __thiscall</h4> <ul><li>C++ のメンバー関数を呼ぶのに用いる</li> <li>現在のオブジェクトポインターをECXに渡す</li> <li>基本的な処理は__stdcallと同じ</li></ul> <h5 id="thiscallの例"><a href="#thiscallの例" class="header-anchor">#</a> __thiscallの例</h5> <div class="language-c extra-class"><pre class="language-c"><code>Class CTemp
<span class="token punctuation">{</span>
  public<span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">MemberFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-nasm extra-class"><pre class="language-nasm"><code>mov    <span class="token register variable">eax</span>, dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">14h</span><span class="token operator">]</span>
push   <span class="token register variable">eax</span>
mov    <span class="token register variable">edx</span>, dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">10h</span><span class="token operator">]</span>
push   <span class="token register variable">edx</span>
lea    <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>     <span class="token comment">; callの前にオブジェクトポインタをecxに格納</span>
call   <span class="token number">402000h</span>
</code></pre></div><h3 id="基本的なif文"><a href="#基本的なif文" class="header-anchor">#</a> 基本的なif文</h3> <p>条件文のコードは以下の流れで行われる。</p> <ol><li><code>cmp</code>でオペランドを比較し、フラグレジスタを更新</li> <li>後に<code>jnz</code>,<code>jz</code>でフラグレジスタの内容を確認し、条件分岐を決定</li></ol> <h3 id="基本的なループ"><a href="#基本的なループ" class="header-anchor">#</a> 基本的なループ</h3> <p>以下の例は、ローカル変数の加算処理を行い<code>i++</code>、ループ条件と比較する部分。特定の値と比較し、結果的に処理を再び行うとこを判定しているものはループだと思えば良い。</p> <div class="language-nasm extra-class"><pre class="language-nasm"><code>mov  <span class="token register variable">eax</span>,<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>             <span class="token comment">; [ebp-8] にループカウンターが格納されている</span>
add  <span class="token register variable">eax</span>,<span class="token number">1</span>                   <span class="token comment">; カウンターの値を加算</span>
mov  <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>,<span class="token register variable">eax</span>             <span class="token comment">; ループを更新</span>
cmp  dword ptr<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">100h</span>  <span class="token comment">; カウンターの値と 100h を比較</span>
jg   short loc_401035        <span class="token comment">; [ebp-8]の値が 100hより大きい場合ジャンプ</span>
</code></pre></div><h3 id="構造体とapiコール"><a href="#構造体とapiコール" class="header-anchor">#</a> 構造体とAPIコール</h3> <p>C言語の文法において構造体は重要な要素である。プログラムを分析する際には構造体の各メンバーがどのように使用されているか確認する必要がある。リバースエンジニアリングにおいて、スタックポインターをみて、構造体の大きさやそのメンバーを把握する必要がある。いつスタックを確保し、確保したスタックをどのように使用したかによって、構造体がどのようなものか推定していく必要がある。
以下の例は、CreateProcessの呼び出しにおいて構造体 <code>STARTUPINFO</code> と構造体 <code>PROCESS_INFORMATION</code> を使ったCのコードとそのアセンブリコードである。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// process_create.c</span>
<span class="token keyword">void</span> <span class="token function">RunProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  STARTUPINFO si<span class="token punctuation">;</span>
  PROCESS_INFORMATION pi<span class="token punctuation">;</span>

  <span class="token function">ZeroMemory</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  si<span class="token punctuation">.</span>cb <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ZeroMemory</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>pi<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Start the child process.</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CreateProcess</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token string">&quot;ChildProcess&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;CreateProcess failed.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Wait until child process exit</span>
    <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> INFINITE <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Close process and thread handles.</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hProcess <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span> pi<span class="token punctuation">.</span>hThread <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-nasm extra-class"><pre class="language-nasm"><code>push      <span class="token register variable">ebp</span>
mov       <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
sub       <span class="token register variable">esp</span>, <span class="token number">54h</span>                     <span class="token comment">; 0x54byte分のスタックを増加している</span>
push      <span class="token number">44h</span>                          <span class="token comment">; ZeroMemory( &amp;si, sizeof(si)); に対応する部分</span>
push      <span class="token number">0</span>                            <span class="token comment">; スタックの0x44byteを初期化</span>
lea       <span class="token register variable">eax</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">54</span><span class="token operator">]</span>    <span class="token comment">;</span>
push      <span class="token register variable">eax</span>                          <span class="token comment">;</span>
call      calling.004011A0             <span class="token comment">; ZeroMemoryの呼び出し</span>
add       <span class="token register variable">esp</span>,0C
mov       dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">54</span><span class="token operator">]</span>,<span class="token number">44h</span>    <span class="token comment">; movで構造体の１番目のメンバー変数の処理。si.cb = sizeof(si)に該当</span>
push      <span class="token number">10</span>                           <span class="token comment">; ZeroMemory( &amp;pi, sizeof(pi)) に対応する部分</span>
push      <span class="token number">0</span>                            <span class="token comment">; スタックの0x10byteを初期化</span>
lea       <span class="token register variable">ecx</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">]</span>    <span class="token comment">;</span>
push      <span class="token register variable">ecx</span>                          <span class="token comment">;</span>
call      calling.004011A0             <span class="token comment">; ZeroMemoryの呼び出し</span>
add       <span class="token register variable">esp</span>,0C
lea       <span class="token register variable">edx</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">]</span>
push      <span class="token register variable">edx</span>                          <span class="token comment">; CreateProcessAの最後の引数をスタックに積む。ここでは`&amp;pi`に該当。</span>
lea       <span class="token register variable">eax</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">54</span><span class="token operator">]</span>
push      <span class="token register variable">eax</span>                          <span class="token comment">; CreateProcessAの後ろから2番目の引数を積む。ここでは`&amp;si`に該当。</span>
push      <span class="token number">0</span>
push      <span class="token number">0</span>
push      <span class="token number">0</span>
push      <span class="token number">0</span>
push      <span class="token number">0</span>
push      <span class="token number">0</span>
push      calling<span class="token number">.00407030</span>             <span class="token comment">; CreateProcessAの呼び出し</span>
push      <span class="token number">0</span>
call      dword ptr <span class="token register variable">ds</span>:CreateProcessA
test      <span class="token register variable">eax</span>,<span class="token register variable">eax</span>                      <span class="token comment">; CreateProicessAの実行結果の確認。test eax,eax で値が0であるか確認。</span>
                                       <span class="token comment">; test は and と実行している演算は同じ。レジストリフラグの更新が異なる。</span>
jnz       short calling<span class="token number">.00401061</span>       <span class="token comment">; NULLリターン時のエラー処理</span>
push      calling<span class="token number">.00407040</span>
call      calling.0040116F
add       <span class="token register variable">esp</span>,<span class="token number">4</span>
jmp       short calling<span class="token number">.00401081</span>
push      <span class="token operator">-</span><span class="token number">1</span>
mov       <span class="token register variable">ecx</span>,dword ptr <span class="token register variable">ss</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">]</span>
push      <span class="token register variable">ecx</span>
call      dword ptr <span class="token register variable">ds</span>:WaitForSingleObject
mov       <span class="token register variable">edx</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">]</span>
push      <span class="token register variable">edx</span>
call      dword ptr <span class="token register variable">ds</span>:CloseHandle
mov       <span class="token register variable">eax</span>,dword ptr <span class="token register variable">ss</span>:<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span>C<span class="token operator">]</span>
push      <span class="token register variable">eax</span>
call      dword ptr <span class="token register variable">ds</span>:CloseHandle
mov       <span class="token register variable">esp</span>,<span class="token register variable">ebp</span>
pop       <span class="token register variable">ebp</span>
retn
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li>リバースエンジニアリングバイブル コード再創造の美学
<ul><li>https://book.impress.co.jp/books/1113101030</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/4/2020, 5:36:01 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e11e3c81.js" defer></script><script src="/assets/js/2.576ddc93.js" defer></script><script src="/assets/js/12.e3466742.js" defer></script>
  </body>
</html>
